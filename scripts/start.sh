#!/bin/bash

# ============================================================================
# ä¼ä¸šçº§ NestJS åç«¯ç³»ç»Ÿ - é¡¹ç›®å¯åŠ¨è„šæœ¬ (Bash)
# ============================================================================
# æè¿°: ç”¨äºå¼€å‘ç¯å¢ƒçš„ä¸€é”®å¯åŠ¨è„šæœ¬ï¼ŒåŒ…å«ç¯å¢ƒæ£€æŸ¥ã€ä¾èµ–å®‰è£…ã€æ•°æ®åº“åˆå§‹åŒ–ç­‰åŠŸèƒ½
# ç”¨æ³•: ./scripts/start.sh
# æ”¯æŒ: Linux / macOS
# ============================================================================

# è®¾ç½®é”™è¯¯å¤„ç†ï¼šé‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
set -e

# ============================================================================
# è¾…åŠ©å‡½æ•°
# ============================================================================

# æ˜¾ç¤ºæ ‡é¢˜ä¿¡æ¯
print_title() {
    echo ""
    echo "ğŸš€ $1"
    echo "======================================================================"
}

# æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
print_success() {
    echo "âœ… $1"
}

# æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
print_warning() {
    echo "âš ï¸  $1"
}

# æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
print_error() {
    echo "âŒ $1"
}

# æ˜¾ç¤ºä¿¡æ¯
print_info() {
    echo "ğŸ“‹ $1"
}

# æ£€æŸ¥å‘½ä»¤æ˜¯å¦å­˜åœ¨
command_exists() {
    command -v "$1" &> /dev/null
}

# ============================================================================
# ä¸»è„šæœ¬å¼€å§‹
# ============================================================================

print_title "ä¼ä¸šçº§ NestJS åç«¯ç³»ç»Ÿå¯åŠ¨è„šæœ¬"

# ============================================================================
# 1. æ£€æŸ¥è¿è¡Œç¯å¢ƒ
# ============================================================================
print_info "æ£€æŸ¥è¿è¡Œç¯å¢ƒ..."

# æ£€æŸ¥ Node.js æ˜¯å¦å®‰è£…
if ! command_exists node; then
    print_error "æœªå®‰è£… Node.jsï¼Œè¯·å…ˆå®‰è£… Node.js 22.0.0 æˆ–æ›´é«˜ç‰ˆæœ¬"
    echo "ä¸‹è½½åœ°å€: https://nodejs.org/"
    exit 1
fi

# è·å–å¹¶éªŒè¯ Node.js ç‰ˆæœ¬
NODE_VERSION=$(node --version)
echo "Node.js ç‰ˆæœ¬: $NODE_VERSION"

# æå–ä¸»ç‰ˆæœ¬å·å¹¶éªŒè¯ï¼ˆéœ€è¦ Node.js 22+ï¼‰
NODE_MAJOR_VERSION=$(echo "$NODE_VERSION" | sed 's/v\([0-9]*\)\..*/\1/')
if [ "$NODE_MAJOR_VERSION" -lt 20 ]; then
    print_error "Node.js ç‰ˆæœ¬è¿‡ä½ï¼Œéœ€è¦ 22.0.0 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œå½“å‰ç‰ˆæœ¬: $NODE_VERSION"
    exit 1
fi

# æ£€æŸ¥ pnpm æ˜¯å¦å®‰è£…
if ! command_exists pnpm; then
    print_error "æœªå®‰è£… pnpmï¼Œè¯·å…ˆå®‰è£…: npm install -g pnpm"
    exit 1
fi

# è·å– pnpm ç‰ˆæœ¬
PNPM_VERSION=$(pnpm --version)
echo "pnpm ç‰ˆæœ¬: $PNPM_VERSION"

# æ£€æŸ¥ Docker æ˜¯å¦å®‰è£…
if ! command_exists docker; then
    print_error "æœªå®‰è£… Dockerï¼Œè¯·å…ˆå®‰è£… Docker"
    echo "ä¸‹è½½åœ°å€: https://www.docker.com/get-started"
    exit 1
fi

# æ£€æŸ¥ Docker æ˜¯å¦è¿è¡Œ
if ! docker ps &> /dev/null; then
    print_error "Docker æœªè¿è¡Œï¼Œè¯·å¯åŠ¨ Docker æœåŠ¡"
    exit 1
fi

print_success "Docker ç¯å¢ƒæ£€æŸ¥é€šè¿‡"

# ============================================================================
# 2. è®¾ç½®ç¯å¢ƒå˜é‡
# ============================================================================
print_info "é…ç½®ç¯å¢ƒå˜é‡..."

# è®¾ç½® NODE_ENVï¼Œå¦‚æœæœªè®¾ç½®åˆ™é»˜è®¤ä¸º development
export NODE_ENV=${NODE_ENV:-development}
echo "ğŸŒ å½“å‰ç¯å¢ƒ: $NODE_ENV"

# ============================================================================
# 3. æ£€æŸ¥ç¯å¢ƒé…ç½®æ–‡ä»¶
# ============================================================================
print_info "æ£€æŸ¥ç¯å¢ƒé…ç½®æ–‡ä»¶..."

ENV_FILE=".env.$NODE_ENV"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
ENV_FILE_PATH="$PROJECT_ROOT/$ENV_FILE"
EXAMPLE_ENV_PATH="$PROJECT_ROOT/.env.example"

# å¦‚æœç¯å¢ƒé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™ä»ç¤ºä¾‹æ–‡ä»¶å¤åˆ¶
if [ ! -f "$ENV_FILE_PATH" ]; then
    print_warning "ç¯å¢ƒé…ç½®æ–‡ä»¶ $ENV_FILE ä¸å­˜åœ¨ï¼Œæ­£åœ¨ä»ç¤ºä¾‹æ–‡ä»¶å¤åˆ¶..."
    if [ -f "$EXAMPLE_ENV_PATH" ]; then
        cp "$EXAMPLE_ENV_PATH" "$ENV_FILE_PATH"
        print_success "å·²åˆ›å»º $ENV_FILE æ–‡ä»¶"
        print_warning "è¯·ç¼–è¾‘ $ENV_FILE æ–‡ä»¶é…ç½®ç›¸å…³å‚æ•°åé‡æ–°è¿è¡Œè„šæœ¬"
        
        # å°è¯•æ‰“å¼€ç¼–è¾‘å™¨
        if command_exists code; then
            code "$ENV_FILE_PATH"
        elif command_exists vim; then
            vim "$ENV_FILE_PATH"
        elif command_exists nano; then
            nano "$ENV_FILE_PATH"
        else
            echo "è¯·æ‰‹åŠ¨ç¼–è¾‘æ–‡ä»¶: $ENV_FILE_PATH"
        fi
        exit 0
    else
        print_error "ç¤ºä¾‹ç¯å¢ƒæ–‡ä»¶ .env.example ä¸å­˜åœ¨"
        exit 1
    fi
else
    print_success "ç¯å¢ƒé…ç½®æ–‡ä»¶å·²å­˜åœ¨"
fi

# ============================================================================
# 4. å®‰è£…é¡¹ç›®ä¾èµ–
# ============================================================================
print_info "å®‰è£…é¡¹ç›®ä¾èµ–..."

cd "$PROJECT_ROOT"

if ! pnpm install; then
    print_error "ä¾èµ–å®‰è£…å¤±è´¥"
    exit 1
fi

print_success "é¡¹ç›®ä¾èµ–å®‰è£…å®Œæˆ"

# ============================================================================
# 5. ç”Ÿæˆ Prisma å®¢æˆ·ç«¯
# ============================================================================
print_info "ç”Ÿæˆ Prisma å®¢æˆ·ç«¯..."

if ! pnpm db:generate; then
    print_error "Prisma å®¢æˆ·ç«¯ç”Ÿæˆå¤±è´¥"
    exit 1
fi

print_success "Prisma å®¢æˆ·ç«¯ç”Ÿæˆå®Œæˆ"

# ============================================================================
# 6. å¯åŠ¨æ•°æ®åº“æœåŠ¡
# ============================================================================
print_info "å¯åŠ¨æ•°æ®åº“æœåŠ¡ï¼ˆMySQL + Redis + ç®¡ç†å·¥å…·ï¼‰..."

if ! pnpm docker:dev; then
    print_error "æ•°æ®åº“æœåŠ¡å¯åŠ¨å¤±è´¥"
    exit 1
fi

print_success "æ•°æ®åº“æœåŠ¡å¯åŠ¨å®Œæˆ"

# ============================================================================
# 7. ç­‰å¾…æ•°æ®åº“æœåŠ¡å®Œå…¨å¯åŠ¨
# ============================================================================
print_info "ç­‰å¾…æ•°æ®åº“æœåŠ¡å®Œå…¨å¯åŠ¨ï¼ˆ15ç§’ï¼‰..."

# æ˜¾ç¤ºè¿›åº¦ï¼ˆBash ç‰ˆæœ¬çš„è¿›åº¦æç¤ºï¼‰
for i in {1..15}; do
    printf "\râ³ å·²ç­‰å¾… %d ç§’..." "$i"
    sleep 1
done
echo ""

print_success "æ•°æ®åº“æœåŠ¡å·²å°±ç»ª"

# ============================================================================
# 8. è¿è¡Œæ•°æ®åº“è¿ç§»
# ============================================================================
print_info "è¿è¡Œæ•°æ®åº“è¿ç§»..."

if pnpm db:migrate; then
    print_success "æ•°æ®åº“è¿ç§»å®Œæˆ"
else
    print_warning "æ•°æ®åº“è¿ç§»å¤±è´¥ï¼Œå¯èƒ½æ˜¯é¦–æ¬¡è¿è¡Œæˆ–è¿ç§»å·²æ‰§è¡Œï¼Œç»§ç»­..."
fi

# ============================================================================
# 9. å¡«å……ç§å­æ•°æ®
# ============================================================================
print_info "å¡«å……ç§å­æ•°æ®..."

if pnpm db:seed; then
    print_success "ç§å­æ•°æ®å¡«å……å®Œæˆ"
else
    print_warning "ç§å­æ•°æ®å¡«å……å¤±è´¥ï¼Œå¯èƒ½æ•°æ®å·²å­˜åœ¨ï¼Œè·³è¿‡..."
fi

# ============================================================================
# 10. å¯åŠ¨åº”ç”¨æœåŠ¡
# ============================================================================
print_title "å¯åŠ¨åº”ç”¨æœåŠ¡"

echo ""
echo "======================================================================"
echo "ï¿½ ç¯å¢ƒå‡†å¤‡å®Œæˆï¼æ­£åœ¨å¯åŠ¨åº”ç”¨..."
echo "======================================================================"
echo ""
echo "ğŸ“ æœåŠ¡åœ°å€:"
echo "   ğŸŒ åº”ç”¨æœåŠ¡:    http://localhost:8000"
echo "   ğŸ“š API æ–‡æ¡£:    http://localhost:8000/api/docs"
echo "   ğŸ—„ï¸  æ•°æ®åº“ç®¡ç†:  http://localhost:8080"
echo "   ğŸ“Š Redis ç®¡ç†:  http://localhost:8081"
echo ""
echo "======================================================================"
echo "ğŸ’¡ æç¤º: æŒ‰ Ctrl+C åœæ­¢æœåŠ¡"
echo "======================================================================"
echo ""

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
pnpm start:dev